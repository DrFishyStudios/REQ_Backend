# REQ_Backend NPC Spawn System - Architecture Diagrams

## System Overview

```
???????????????????????????????????????????????????????????????????
?                        Zone Server                              ?
?                                                                 ?
?  ????????????????????        ????????????????????             ?
?  ?   ZoneServer     ?        ? ZoneSpawnManager ?             ?
?  ?                  ?        ?                  ?             ?
?  ?  - players_      ??????????  - templates_    ?             ?
?  ?  - npcs_         ?        ?  - spawnTable_   ?             ?
?  ?  - corpses_      ?        ?  - timers_       ?             ?
?  ?  - groups_       ?        ?                  ?             ?
?  ?                  ?        ????????????????????             ?
?  ?  tick loop (20Hz)?               ?                         ?
?  ?  - updateNpcs()  ?               ?                         ?
?  ?  - updateRespawns()???????????????                         ?
?  ?  - broadcast()   ?                                         ?
?  ????????????????????                                         ?
?                                                                 ?
???????????????????????????????????????????????????????????????????
         ?                    ?                    ?
         ?                    ?                    ?
         ?                    ?                    ?
???????????????????  ???????????????????  ???????????????????
?  npcs.json      ?  ? spawns_10.json  ?  ?  AttackRequest  ?
?                 ?  ?                 ?  ?  AttackResult   ?
? - NPC templates ?  ? - Spawn points  ?  ?  (Protocol)     ?
? - Stats         ?  ? - Spawn groups  ?  ?                 ?
? - Behaviors     ?  ? - Timers        ?  ?  Client ? Server?
???????????????????  ???????????????????  ???????????????????
```

---

## Data Flow: Spawn Initialization

```
Zone Server Startup
         ?
         ?
???????????????????????????????????
? Load NPC Templates              ?
? loadNpcTemplates("npcs.json")  ?
?                                 ?
? Result: NpcTemplateStore        ?
? - Map<id, NpcTemplate>          ?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? Create ZoneSpawnManager         ?
? - Pass zoneId                   ?
? - Pass templates reference      ?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? Load Spawn Table                ?
? loadSpawnTable("spawns_10.json")?
?                                 ?
? Result: SpawnTable              ?
? - Map<id, SpawnGroup>           ?
? - Vector<SpawnPoint>            ?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? Initialize Spawns               ?
? For each spawn point:           ?
?   1. Select NPC from group      ?
?   2. Create ZoneNpc instance    ?
?   3. Set position from spawn    ?
?   4. Add to npcs_ map           ?
?   5. Track spawn ? npc mapping  ?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? Zone Ready                      ?
? - 15 NPCs spawned               ?
? - 5 spawn groups loaded         ?
? - Simulation tick started       ?
???????????????????????????????????
```

---

## Data Flow: Combat & Respawn

```
Player Attacks NPC
         ?
         ?
???????????????????????????????????
? AttackRequest                   ?
? - attackerCharacterId           ?
? - targetId (NPC)                ?
? - abilityId                     ?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? ZoneServer::processAttack()    ?
? - Validate range                ?
? - Calculate damage              ?
? - Apply damage to NPC           ?
? - Add hate to NPC               ?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? NPC HP <= 0?                    ?
???????????????????????????????????
         ? YES
         ?
???????????????????????????????????
? handleNpcDeath()                ?
? - npc.isAlive = false           ?
? - npc.aiState = Dead            ?
? - clearHate(npc)                ?
? - awardXpForNpcKill()           ?
? - dropLoot()                    ?
? - spawnManager->markForRespawn()?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? ZoneSpawnManager::markForRespawn?
? - Get spawn point for NPC       ?
? - Calculate respawn time        ?
?   (base + variance)             ?
? - Start timer for spawn point   ?
? - Remove NPC from npcs_ map     ?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? Simulation Loop (every tick)   ?
? updateRespawns(deltaTime)       ?
? - Decrement all timers          ?
? - Check for expired timers      ?
???????????????????????????????????
         ? Timer expired?
         ? YES
???????????????????????????????????
? Respawn NPC                     ?
? - Select NPC from spawn group   ?
?   (or use direct_npc_id)        ?
? - Create new ZoneNpc instance   ?
? - Set position from spawn point ?
? - Add to npcs_ map              ?
? - Log respawn event             ?
???????????????????????????????????
         ?
         ?
???????????????????????????????????
? EntitySpawn message (future)    ?
? Send to nearby clients          ?
???????????????????????????????????
```

---

## Spawn Group Selection (Weighted Random)

```
Spawn Point Definition:
{
  "spawn_id": 5,
  "spawn_group_id": 103,
  "position": { "x": 300.0, "y": 150.0, "z": 0.0 }
}

Spawn Group Definition:
{
  "spawn_group_id": 103,
  "entries": [
    { "npc_id": 1001, "weight": 95 },  ? 95% "A Decaying Skeleton"
    { "npc_id": 1006, "weight": 5 }    ? 5%  "Skeleton Warlord" (named)
  ]
}

Selection Algorithm:
???????????????????????????????????
? Total weight = 95 + 5 = 100     ?
? Random value = rand() % 100     ?
?                                 ?
? Range  0-94  ? NPC 1001         ?
? Range 95-99  ? NPC 1006         ?
???????????????????????????????????

Result: Classic placeholder/named system
- Most spawns: common mob
- Rare spawns: named boss
- Players camp and wait for named
```

---

## AI State Machine (Existing)

```
????????
? Idle ?  ? Start state
????????
   ? Proximity aggro
   ?
????????
?Alert ?  ? Quick validation
????????
   ? Target valid
   ?
???????????
?Engaged  ?????  ? Combat loop
???????????   ?    - Attack target
   ?          ?    - Move to range
   ?          ?    - Check leash
   ????????????
   ? No target / Too far
   ?
????????????
?Leashing  ?  ? Return to spawn
????????????
   ? Reached spawn
   ?
????????
? Idle ?  ? Reset & heal
????????

Special States:
???????????
?Fleeing  ?  ? HP < 25%, run away
???????????

????????
?Dead  ?  ? HP <= 0, mark for respawn
????????
```

---

## Hate/Aggro System (Existing)

```
NPC Hate Table:
??????????????????????????????????
? EntityID  ?  Hate Value        ?
??????????????????????????????????
? Player 42 ?  250.0  ? Top hate ?
? Player 43 ?  180.0             ?
? Player 44 ?   50.0             ?
??????????????????????????????????

Hate Sources:
- Melee damage:  hate += damage × 1.0
- Spell damage:  hate += damage × 1.2
- Healing ally:  hate += heal × 0.5 (split)
- CC/Debuff:     hate += 50.0 (flat bonus)
- Taunt skill:   hate = topHate + 1

Social Aggro:
????????????????????????????????????
? NPC A is attacked by Player 42   ?
? NPC B is within social radius    ?
? NPC B is same faction as NPC A   ?
? ? NPC B adds Player 42 to hate   ?
?   with hate = 0.5 × NPC A's hate ?
????????????????????????????????????
```

---

## File Structure

```
REQ_Backend/
?
??? config/
?   ??? npcs.json                    ? Global NPC templates
?   ?
?   ??? zones/
?       ??? spawns_10.json           ? Zone 10 spawn table
?       ??? spawns_20.json           ? Zone 20 spawn table
?       ??? zone_10_config.json      ? Zone 10 settings
?
??? REQ_Shared/
?   ??? include/req/shared/
?   ?   ??? DataModels.h             ? ZoneNpc, NpcTemplate, SpawnTable
?   ?   ??? Config.h                 ? loadNpcTemplates(), loadSpawnTable()
?   ?   ??? Protocol_Combat.h        ? AttackRequest, AttackResult
?   ?
?   ??? src/
?       ??? Config.cpp               ? JSON loaders
?
??? REQ_ZoneServer/
    ??? include/req/zone/
    ?   ??? ZoneServer.h             ? Main server class
    ?   ??? ZoneSpawnManager.h       ? NEW: Spawn manager
    ?
    ??? src/
        ??? ZoneServer.cpp           ? Server lifecycle
        ??? ZoneServer_Npc.cpp       ? AI state machine
        ??? ZoneServer_Combat.cpp    ? Combat resolution
        ??? ZoneServer_Simulation.cpp? 20Hz tick loop
        ??? ZoneSpawnManager.cpp     ? NEW: Spawn logic
```

---

## Sequence Diagram: Full Combat Cycle

```
Player          ZoneServer      ZoneSpawnManager    ZoneNpc
  ?                 ?                  ?               ?
  ? AttackRequest   ?                  ?               ?
  ???????????????????                  ?               ?
  ?                 ? processAttack()  ?               ?
  ?                 ????????????????????????????????????
  ?                 ?                  ? Apply damage  ?
  ?                 ?                  ? HP -= 25      ?
  ?                 ????????????????????????????????????
  ? AttackResult    ?                  ?               ?
  ???????????????????                  ?               ?
  ? (Hit 25 dmg)    ?                  ?               ?
  ?                 ?                  ?               ?
  ? AttackRequest   ?                  ?               ?
  ???????????????????                  ?               ?
  ?                 ? processAttack()  ?               ?
  ?                 ????????????????????????????????????
  ?                 ?                  ? HP -= 25      ?
  ?                 ?                  ? HP = 0        ?
  ?                 ????????????????????????????????????
  ?                 ? handleNpcDeath() ?               ?
  ?                 ?                  ?               ?
  ?                 ? markForRespawn() ?               ?
  ?                 ????????????????????               ?
  ?                 ?                  ? Start timer   ?
  ?                 ?                  ? (120s ± 30s)  ?
  ?                 ????????????????????               ?
  ? AttackResult    ?                  ?               ?
  ???????????????????                  ?               ?
  ? (Hit 25 dmg,    ?                  ?               ?
  ?  target dead)   ?                  ?               ?
  ?                 ?                  ?               ?
  ?                 ? ... 120 seconds pass ...         ?
  ?                 ?                  ?               ?
  ?                 ? updateRespawns() ?               ?
  ?                 ????????????????????               ?
  ?                 ?                  ? Timer expired ?
  ?                 ?                  ? Create new NPC?
  ?                 ????????????????????               ?
  ?                 ?                  ?               ?
  ? EntitySpawn     ?                  ?               ?
  ???????????????????                  ?               ?
  ? (future)        ?                  ?               ?
```

---

## JSON Schema Relationships

```
???????????????????????????????????????????????????????????????
?                       npcs.json                             ?
?                                                             ?
?  NpcTemplate (id: 1001)                                     ?
?  ????????????????????????????????????????????????????????? ?
?  ? - id: 1001                                            ? ?
?  ? - name: "A Decaying Skeleton"                         ? ?
?  ? - archetype: "melee_trash"                            ? ?
?  ? - stat_block: { level: 1-2, hp: 20, ... }            ? ?
?  ? - behavior_flags: { is_social: true, ... }           ? ?
?  ? - behavior_params: { aggro_radius: 800.0, ... }      ? ?
?  ? - visual_id: "skeleton_basic"                        ? ?
?  ????????????????????????????????????????????????????????? ?
?                                                             ?
?  NpcTemplate (id: 1002)                                     ?
?  ????????????????????????????????????????????????????????? ?
?  ? - id: 1002                                            ? ?
?  ? - name: "A Rat"                                       ? ?
?  ? - ...                                                 ? ?
?  ????????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????????
                         ?
                         ? References
                         ?
???????????????????????????????????????????????????????????????
?                  spawns_10.json                             ?
?                                                             ?
?  SpawnGroup (id: 101)                                       ?
?  ????????????????????????????????????????????????????????? ?
?  ? - spawn_group_id: 101                                 ? ?
?  ? - entries:                                            ? ?
?  ?   - { npc_id: 1001, weight: 60 }  ? References npcs  ? ?
?  ?   - { npc_id: 1002, weight: 30 }                      ? ?
?  ?   - { npc_id: 1003, weight: 10 }                      ? ?
?  ????????????????????????????????????????????????????????? ?
?                                                             ?
?  SpawnPoint (id: 1)                                         ?
?  ????????????????????????????????????????????????????????? ?
?  ? - spawn_id: 1                                         ? ?
?  ? - position: { x: 100.0, y: 50.0, z: 0.0 }            ? ?
?  ? - spawn_group_id: 101  ? References spawn group      ? ?
?  ? - respawn_time_sec: 120.0                            ? ?
?  ? - respawn_variance_sec: 30.0                         ? ?
?  ????????????????????????????????????????????????????????? ?
?                                                             ?
?  SpawnPoint (id: 2)                                         ?
?  ????????????????????????????????????????????????????????? ?
?  ? - spawn_id: 2                                         ? ?
?  ? - position: { x: 200.0, y: 75.0, z: 0.0 }            ? ?
?  ? - direct_npc_id: 1002  ? Direct reference to NPC     ? ?
?  ? - respawn_time_sec: 90.0                             ? ?
?  ????????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????????
                         ?
                         ? Instantiates
                         ?
???????????????????????????????????????????????????????????????
?                  Runtime: ZoneServer                        ?
?                                                             ?
?  npcs_ map:                                                 ?
?  ????????????????????????????????????????????????????????? ?
?  ? Key: 1000001  ? Value: ZoneNpc                        ? ?
?  ?   - npcId: 1000001                                    ? ?
?  ?   - name: "A Decaying Skeleton"                       ? ?
?  ?   - level: 1                                          ? ?
?  ?   - currentHp: 20, maxHp: 20                          ? ?
?  ?   - posX: 100.0, posY: 50.0, posZ: 0.0               ? ?
?  ?   - spawnX: 100.0, spawnY: 50.0, spawnZ: 0.0         ? ?
?  ?   - aiState: Idle                                     ? ?
?  ?   - hateTable: {}                                     ? ?
?  ????????????????????????????????????????????????????????? ?
?                                                             ?
?  npcToSpawnId_ map:                                         ?
?  ????????????????????????????????????????????????????????? ?
?  ? 1000001 ? 1  (tracks which spawn point owns this NPC)? ?
?  ????????????????????????????????????????????????????????? ?
?                                                             ?
?  spawnRespawnTimers_ map:                                   ?
?  ????????????????????????????????????????????????????????? ?
?  ? (empty until NPC dies)                                ? ?
?  ????????????????????????????????????????????????????????? ?
???????????????????????????????????????????????????????????????
```

---

## Legend

```
???????
? Box ?  = Component, file, or data structure
???????

  ?     = Data flow, reference, or action

  ???   = Bidirectional relationship

  ???   = List or table border

  ...   = Continuation or time passage
```
